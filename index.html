<html>
<head>
    <!-- Apua karttaan osoitteesta http://harrywood.co.uk/maps/examples/openlayers/remove-marker.view.html -->
    <title>Map</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/2.11/lib/OpenLayers.js"></script>
    <style type="text/css">
        html, body, #mapdiv {
            width:85%; height:85%; margin:0;
        }
        body {
            background-color: powderblue;
        }

    </style>
</head>

<body>
<div id="mapdiv"></div>
<div class="dropdown">
    <select id="description" >
    </select>
    <button id="button" type="button" >Find the station</button>
</div>
<div>
    <p id="name"></p>
    <p id="free"></p>
    <p id="empty"></p>
    <p id="longitude"></p>
    <p id="latitude"></p>
    <p id="temp"></p>
    <p><img id="weathericon" src="" alt=""/></p>


</div>
<div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
<script>

    function doRequest(url, vl) {
        //--- http request!
        var xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                let myArr = JSON.parse(xmlhttp.responseText);
                console.log("Responsetext " + xmlhttp.responseText);
                if (vl) {
                    //console.log("This is the lenght of the array " +myArr.length);
                    console.log("Longitude coordinate " + myArr.coord.lon);
                    handleWeather(myArr);
                    console.log("Tööttötöö");
                } else {
                    aFunction(myArr); // 3
                }

            }
        }
        xmlhttp.open("GET", url, true); // 4
        xmlhttp.send();
        //---
    }
    var url = "http://api.citybik.es/v2/networks/citybikes-helsinki?fields=stations"; // 2

    var vectorLayer = null;
    doRequest(url, vectorLayer);
    var longit = 24.9425268;
    var latit = 60.1708236;

    function aFunction(arr) { // 5
        var arr2 = arr.network.stations;
        var out = "";
        var i;
        var all = "";
        let arrSorted = arr2.sort((a, b) => {
            return a.name.localeCompare(b.name);
        });

        for (i = 0; i < arrSorted.length; i++) {
            out += "<option value='" + i + "'>" + arrSorted[i].name + "</option>";
        }

        document.getElementById("description").innerHTML = out; // 6

        let button = document.getElementById("button");

        button.onclick = function(){
            let choice = parseInt(document.getElementById("description").value, 10);
            console.log(choice);
            console.log(arrSorted[choice].name);
            document.getElementById("name").innerHTML = arrSorted[choice].name;
            document.getElementById("free").innerHTML = "Free bikes: " + arrSorted[choice].free_bikes;
            document.getElementById("empty").innerHTML = "Empty slots: " + arrSorted[choice].empty_slots;

            goToPlace(arrSorted[choice].longitude, arrSorted[choice].latitude);

            createAMarker(arrSorted[choice].longitude, arrSorted[choice].latitude);
            console.log("marker created");
            //tämä uutta
            showWeather(arrSorted[choice].longitude, arrSorted[choice].latitude)
        }
    }

    //harrywood.co.uk/maps/examples/openlayers/marker-array.view.html
    var map = new OpenLayers.Map("mapdiv");
    map.addLayer(new OpenLayers.Layer.OSM());
    epsg4326 =  new OpenLayers.Projection("EPSG:4326"); //WGS 1984 projection
    projectTo = map.getProjectionObject(); //The map projection (Spherical Mercator)

    console.log("vectorLayer on " + vectorLayer);

    function goToPlace(longit, latit){
        var lonLat = new OpenLayers.LonLat( longit, latit ).transform(epsg4326, projectTo);
        var zoom = 16;
        map.setCenter(lonLat, zoom);
    }

    function createAMarker(longitude, latitude){
        if (vectorLayer){
            //vectorLayer.removeFeatures( [ feature ] ); //ei tunnu toimivan :(
            vectorLayer.removeAllFeatures();
        }
        vectorLayer = new OpenLayers.Layer.Vector("Overlay");
        let feature = new OpenLayers.Feature.Vector(
            new OpenLayers.Geometry.Point( longitude, latitude ).transform(epsg4326, projectTo),
            {description:'This is the value of<br>the description attribute'},
            //kuvan lähde <div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
            {externalGraphic: './map-marker.png', graphicHeight: 25, graphicWidth: 21, graphicXOffset:-12, graphicYOffset:-25  }
            );
        vectorLayer.addFeatures(feature);
        map.addLayer(vectorLayer);
    }


    goToPlace(longit, latit);


    function showWeather(longitude, latitude) {
        console.log("weather function works 1");

        var url2 = "http://api.openweathermap.org/data/2.5/weather?lat=" + latitude + "&lon=" + longitude + "&appid="; // 2
        doRequest(url2, vectorLayer);

    }

    function handleWeather(arr) {
        console.log("This is the temperature in F " + arr.main.temp);
        let tempInK = parseFloat(arr.main.temp);
        let tempInC = tempInK - 273.15;
        let tempShow = tempInC.toFixed(1);
        console.log("This is the temperature in C " + tempShow);
        let weathericon = arr.weather[0].icon;
        console.log("Description " + weathericon);
        document.getElementById("temp").innerHTML = "Temperature now: " + tempShow + " degrees Celsius";

        let image = "http://openweathermap.org/img/wn/" + weathericon + "@2x.png"
        document.getElementById("weathericon").src = image;
        document.getElementById("weathericon").alt = "weather icon";


    }
    //sää
    //api.openweathermap.org/data/2.5/weather?lat=60.1708236&lon=24.9425268&appid=
    //https://openweathermap.org/current
    //to do -divit säälle -tietojen näyttäminen diveissä -ikoni

</script>

</body></html>